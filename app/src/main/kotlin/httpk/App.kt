/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package httpk

import httpk.handler.Worker
import httpk.util.acceptSuspending
import kotlinx.coroutines.launch
import kotlinx.coroutines.runBlocking
import java.net.ServerSocket
import java.time.Instant
import java.time.ZoneId
import java.time.format.DateTimeFormatter

fun log(message: String) {
    val dateTimeFormatter = DateTimeFormatter
        .ofPattern("uuuu-MM-dd HH:mm:ss.SSS")
        .withZone(ZoneId.of("Asia/Tokyo"))
    val timestamp = dateTimeFormatter.format(Instant.now())
    println("[${timestamp}] [${Thread.currentThread().name}] $message")
}

class App() {

    fun listen(port: Int) {
        val serverSocket = ServerSocket(port)
        log("server start. waiting on port $port")

        serverSocket.use { dispatchRequests(it) }
    }

    private fun dispatchRequests(serverSocket: ServerSocket) = runBlocking {
        while (true) {
            val socket = serverSocket.acceptSuspending()
            launch {
                socket.use { Worker().execute(it) }
            }
        }
    }

}

fun main() {
    Runtime.getRuntime().addShutdownHook(Thread { log("server terminated.") })
    System.setProperty("kotlinx.coroutines.debug", "on")

    App().listen(8080)
}
