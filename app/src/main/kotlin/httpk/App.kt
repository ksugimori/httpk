/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package httpk

import httpk.handler.EchoHandler
import kotlinx.coroutines.*
import java.net.ServerSocket
import java.net.Socket

// TODO パラメーターにする
private const val DEFAULT_SERVER_PORT = 8080

fun log(message: String) = println("[LOG] [${Thread.currentThread().name}] $message")

class App {
    private val port = DEFAULT_SERVER_PORT
    fun start() = runBlocking {
        val serverSocket = initServerSocketSuspend()
        log("server start. waiting on port $port")

        serverSocket.use {
            while (true) {
                val socket = acceptSuspend(it)
                launch { EchoHandler().handle(socket) }
            }
        }
    }

    //
    // private
    //

    private suspend fun acceptSuspend(it: ServerSocket): Socket {
        return withContext(Dispatchers.IO) { it.accept() }
    }

    private suspend fun initServerSocketSuspend(): ServerSocket {
        return withContext(Dispatchers.IO) { ServerSocket(port) }
    }

}

fun main() {
    System.setProperty("kotlinx.coroutines.debug", "on")
    App().start()
}
